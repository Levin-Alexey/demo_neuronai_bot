# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. **–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞** –≤ `models.py`:
   - `check_user_access()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –Ω–∞ 24 —á–∞—Å–∞

2. **Middleware** –≤ `main.py`:
   - `AccessCheckMiddleware` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø
   - –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è 24 —á–∞—Å–æ–≤

3. **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** –≤ `main.py`:
   - `check_access_status` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ—Å—Ç—É–ø–∞
   - `contact_manager_expired` - —Å–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º

## üöÄ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -> /start -> –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (started_at) -> 24 —á–∞—Å–∞ –¥–æ—Å—Ç—É–ø–∞
                                                              ‚Üì
                                                         –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
                                                              ‚Üì
                                            –õ—é–±–∞—è –∫–Ω–æ–ø–∫–∞ -> –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞
                                                              ‚Üì
                                            "–°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º"
```

## üìù –ß—Ç–æ –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

### –ê–∫—Ç–∏–≤–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ö–Ω–æ–ø–∫–∞ "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è

### –ò—Å—Ç–µ–∫—à–∏–π –¥–æ—Å—Ç—É–ø
```
‚è∞ –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –∏—Å—Ç–µ–∫

–í–∞—à –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (24 —á–∞—Å–∞) –∑–∞–∫–æ–Ω—á–∏–ª—Å—è 13.01.2026 –≤ 15:30.

üîπ –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
üîπ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /manager

[üë§ –°–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º] [üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø]
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ò–∑–º–µ–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥ –¥–æ—Å—Ç—É–ø–∞
–í `models.py`, —Ñ—É–Ω–∫—Ü–∏—è `check_user_access()`:
```python
access_until = user.started_at + timedelta(hours=24)  # –ò–∑–º–µ–Ω–∏—Ç–µ 24
```

### –ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å
–í `main.py`, –≤ middleware –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:
```python
local_time = access_until + timedelta(hours=3)  # MSK (UTC+3)
```

–ó–∞–º–µ–Ω–∏—Ç–µ `hours=3` –Ω–∞ –≤–∞—à —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å:
- **MSK** (–ú–æ—Å–∫–≤–∞): `3`
- **UTC** (–õ–æ–Ω–¥–æ–Ω): `0`
- **EST** (–ù—å—é-–ô–æ—Ä–∫): `-5`
- **PST** (–õ–æ—Å-–ê–Ω–¥–∂–µ–ª–µ—Å): `-8`
- **IST** (–ò–Ω–¥–∏—è): `5.5`

## üîß –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –≤—Ä—É—á–Ω—É—é

### SQL –∑–∞–ø—Ä–æ—Å
```sql
UPDATE users 
SET started_at = NOW() 
WHERE telegram_id = 123456789;
```

### Python –∫–æ–¥
```python
from datetime import datetime, timezone
from models import get_session, User

with get_session() as session:
    user = session.query(User).filter_by(telegram_id=123456789).first()
    if user:
        user.started_at = datetime.now(timezone.utc)
        session.commit()
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**
   ```
   /start ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí 24 —á–∞—Å–∞ –∞–∫—Ç–∏–≤–Ω—ã
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞**
   ```
   üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è
   ```

3. **–°–∏–º—É–ª—è—Ü–∏—è –∏—Å—Ç–µ—á–µ–Ω–∏—è** (–¥–ª—è —Ç–µ—Å—Ç–∞)
   ```sql
   UPDATE users 
   SET started_at = NOW() - INTERVAL '25 hours' 
   WHERE telegram_id = YOUR_ID;
   ```

4. **–ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è**
   ```
   –õ—é–±–∞—è –∫–Ω–æ–ø–∫–∞ ‚Üí –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ ‚Üí –°–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º
   ```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Å—Ç–µ–∫—à–∏–º –¥–æ—Å—Ç—É–ø–æ–º
```sql
SELECT telegram_id, started_at, 
       started_at + INTERVAL '24 hours' as access_until,
       NOW() - (started_at + INTERVAL '24 hours') as expired_ago
FROM users
WHERE started_at + INTERVAL '24 hours' < NOW()
ORDER BY started_at DESC;
```

### –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
SELECT telegram_id, started_at,
       started_at + INTERVAL '24 hours' as access_until,
       (started_at + INTERVAL '24 hours') - NOW() as time_left
FROM users
WHERE started_at + INTERVAL '24 hours' > NOW()
ORDER BY started_at DESC;
```

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Middleware –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ `main.py`:
```python
dp.message.middleware(AccessCheckMiddleware())
```

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ—Ç–∞
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `started_at` –≤ –ë–î
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å (UTC)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `print(f"Access check error: {e}")`

### –ö–æ–º–∞–Ω–¥–∞ /start –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
Middleware –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç `/start` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
```python
if hasattr(message, 'text') and message.text and \
   message.text.startswith('/start'):
    return await handler(event, data)
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [ACCESS_CONTROL_README.md](ACCESS_CONTROL_README.md)
