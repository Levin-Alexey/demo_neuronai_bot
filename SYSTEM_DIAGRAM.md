# 📊 Визуальная схема: Система контроля доступа

## 🔄 Полный цикл работы

```
┌─────────────────────────────────────────────────────────────────────┐
│                        НОВЫЙ ПОЛЬЗОВАТЕЛЬ                           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ /start
                                  ▼
                        ┌──────────────────┐
                        │   main.py        │
                        │  cmd_start()     │
                        └──────────────────┘
                                  │
                                  ▼
                   ┌─────────────────────────────┐
                   │  models.py                  │
                   │  ensure_user_started()      │
                   │                             │
                   │  Создание записи в БД:      │
                   │  - telegram_id              │
                   │  - started_at = NOW() (UTC) │
                   └─────────────────────────────┘
                                  │
                                  ▼
                        ┌──────────────────┐
                        │  Доступ активен  │
                        │    24 часа       │
                        └──────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    ПОЛЬЗОВАТЕЛЬ С АКТИВНЫМ ДОСТУПОМ                 │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                       Любое действие в боте
                                  │
                                  ▼
                   ┌──────────────────────────┐
                   │   AccessCheckMiddleware  │
                   │      (main.py)           │
                   └──────────────────────────┘
                                  │
                                  ▼
                   ┌──────────────────────────┐
                   │  check_user_access()     │
                   │     (models.py)          │
                   │                          │
                   │  NOW() - started_at      │
                   │       < 24h ?            │
                   └──────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                   ✅ ДА                       ❌ НЕТ
                    │                           │
                    ▼                           ▼
            ┌───────────────┐         ┌────────────────┐
            │ Доступ есть   │         │ Доступ истек   │
            │ Продолжить    │         │ БЛОКИРОВКА     │
            │ обработку     │         └────────────────┘
            └───────────────┘                   │
                    │                           │
                    ▼                           ▼
            ┌───────────────┐         ┌────────────────┐
            │  🎯 Бот       │         │  ⏰ Сообщение  │
            │  работает     │         │  об истечении  │
            └───────────────┘         └────────────────┘
                                                │
                                                ▼
                                      ┌──────────────────┐
                                      │  Кнопки:         │
                                      │  - Связаться с   │
                                      │    менеджером    │
                                      │  - Проверить     │
                                      │    доступ        │
                                      └──────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                      УПРАВЛЕНИЕ АДМИНИСТРАТОРОМ                     │
└─────────────────────────────────────────────────────────────────────┘

        ┌────────────────────┐              ┌────────────────────┐
        │  Python утилита    │              │   SQL запросы      │
        │  manage_access.py  │              │   в psql/pgAdmin   │
        └────────────────────┘              └────────────────────┘
                 │                                    │
                 ▼                                    ▼
        ┌────────────────────┐              ┌────────────────────┐
        │ Интерактивное меню │              │ Прямые UPDATE      │
        │                    │              │ команды            │
        │ 1. Информация      │              │                    │
        │ 2. Продлить        │              │ UPDATE users       │
        │ 3. Массовое        │              │ SET started_at     │
        │ 4. Активные        │              │ = NOW()            │
        │ 5. Истекшие        │              │ WHERE ...          │
        └────────────────────┘              └────────────────────┘
                 │                                    │
                 └────────────┬───────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  PostgreSQL БД   │
                    │  Таблица: users  │
                    └──────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │  started_at      │
                    │  обновлен        │
                    │                  │
                    │  Доступ продлен  │
                    │  на 24 часа      │
                    └──────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                        ПРОВЕРКА ДОСТУПА                             │
└─────────────────────────────────────────────────────────────────────┘

        Пользователь нажимает "🔄 Проверить доступ"
                              │
                              ▼
                   ┌──────────────────────┐
                   │ check_access_status()│
                   │     (main.py)        │
                   └──────────────────────┘
                              │
                              ▼
                   ┌──────────────────────┐
                   │ check_user_access()  │
                   │    (models.py)       │
                   └──────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
               ✅ Активен                  ❌ Истек
                │                           │
                ▼                           ▼
    ┌───────────────────────┐   ┌───────────────────────┐
    │ ✅ Доступ активен     │   │ ⏰ Доступ истек       │
    │                       │   │                       │
    │ ⏰ Осталось:          │   │ Для продления         │
    │    18 ч. 45 мин.      │   │ свяжитесь с           │
    │                       │   │ менеджером            │
    │ 📅 Доступ до:         │   │                       │
    │    14.01.2026 15:30   │   │ [👤 Связаться]       │
    └───────────────────────┘   └───────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                    СВЯЗЬ С МЕНЕДЖЕРОМ                               │
└─────────────────────────────────────────────────────────────────────┘

    Пользователь нажимает "👤 Связаться с менеджером"
                              │
                              ▼
                 ┌────────────────────────┐
                 │ contact_manager()      │
                 │   (main.py)            │
                 │                        │
                 │ Устанавливает состояние│
                 │ ManagerState.waiting   │
                 └────────────────────────┘
                              │
                              ▼
                 ┌────────────────────────┐
                 │ Форма обратной связи   │
                 │                        │
                 │ "Напишите Ваше         │
                 │  сообщение..."         │
                 │                        │
                 │ [❌ Отмена]            │
                 └────────────────────────┘
                              │
                   Пользователь отправляет
                              │
                              ▼
                 ┌────────────────────────┐
                 │ Сообщение отправлено   │
                 │ менеджеру в Telegram   │
                 │                        │
                 │ ID менеджера: 525944420│
                 └────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                       СТРУКТУРА БАЗЫ ДАННЫХ                         │
└─────────────────────────────────────────────────────────────────────┘

                        ┌──────────────────┐
                        │  users (таблица) │
                        └──────────────────┘
                                 │
                ┌────────────────┼────────────────┐
                │                │                │
                ▼                ▼                ▼
         ┌───────────┐   ┌──────────────┐  ┌──────────┐
         │    id     │   │ telegram_id  │  │started_at│
         │ (PK, int) │   │ (bigint)     │  │(timestmp)│
         │           │   │  UNIQUE      │  │   UTC    │
         └───────────┘   └──────────────┘  └──────────┘
                                                  │
                                                  │
                                    ┌─────────────┴─────────────┐
                                    │                           │
                                    │  Проверка:                │
                                    │  started_at + 24h > NOW() │
                                    │                           │
                                    │  ✅ = Доступ есть         │
                                    │  ❌ = Доступ истек        │
                                    └───────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                     ВРЕМЕННАЯ ШКАЛА (24 ЧАСА)                       │
└─────────────────────────────────────────────────────────────────────┘

    0h          6h          12h         18h         24h
    │───────────│───────────│───────────│───────────│
    ↑                                                ↑
  /start                                        Истекает
  (started_at)                                  доступ
    │                                                │
    └────────────── 24 ЧАСА ДОСТУПА ─────────────────┘
    
    ✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅✅ ❌❌❌❌❌
    │◄──────────── Бот работает ──────────►│ Блокировка
    

┌─────────────────────────────────────────────────────────────────────┐
│                         ФАЙЛЫ СИСТЕМЫ                               │
└─────────────────────────────────────────────────────────────────────┘

            ┌────────────────────────────────────┐
            │     ОСНОВНОЙ КОД                   │
            ├────────────────────────────────────┤
            │ main.py                            │
            │  ├─ AccessCheckMiddleware  ◄───┐   │
            │  ├─ check_access_status()      │   │
            │  └─ contact_manager()          │   │
            │                                │   │
            │ models.py                      │   │
            │  └─ check_user_access() ◄──────┘   │
            └────────────────────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            │                               │
            ▼                               ▼
    ┌────────────────┐           ┌─────────────────┐
    │  УПРАВЛЕНИЕ    │           │  ДОКУМЕНТАЦИЯ   │
    ├────────────────┤           ├─────────────────┤
    │manage_access.py│           │ACCESS_CONTROL   │
    │ - get_user_info│           │_README.md       │
    │ - extend_access│           │                 │
    │ - main_menu    │           │QUICKSTART       │
    │                │           │_ACCESS_CONTROL  │
    │access_control  │           │.md              │
    │_queries.sql    │           │                 │
    │ - 24 запроса   │           │CHANGES_SUMMARY  │
    │ - views        │           │.md              │
    │ - статистика   │           │                 │
    └────────────────┘           │MANAGE_ACCESS    │
                                 │_README.md       │
                                 │                 │
                                 │CHEATSHEET.md    │
                                 └─────────────────┘

```

## 📊 Статистика компонентов

| Компонент | Количество | Описание |
|-----------|------------|----------|
| Функции в models.py | 1 | check_user_access |
| Middleware в main.py | 1 | AccessCheckMiddleware |
| Обработчики в main.py | 2 | check_access_status, contact_manager |
| SQL запросов | 24 | Полный набор для управления |
| README файлов | 6 | Вся документация |
| Python утилит | 1 | manage_access.py |

---

**Создано:** 13 января 2026  
**Версия:** 1.0  
**Статус:** ✅ Полностью функционально
